
```{r libraries, warning = FALSE}

library(tidyverse)
library(ggplot2)
library(zoo)
library(forecast)
library(xts)
library(readxl)
library(dynlm)
library(lmtest)

```

### Basic Cleaning & Processing

```{r test}

# reading the GDP data
RGDP_Data <- read_excel("RGDP Data.xlsx")

# extracting the most revised values/recent data (2024 Q1) 
latest_data <- RGDP_Data$ROUTPUT24Q1

# creating a lag for all quarters
lag(latest_data)

# check is a dataset to validate whether the data is stationary 
check <- data.frame(RGDP_Data$DATE, (latest_data), lag(latest_data))

check <- check %>% 
  rename(c("Date" = "RGDP_Data.DATE",
           "Raw Data" = "X.latest_data.",
           "First Lag" = "lag.latest_data."))

# calculating growth rate of GDP from one quarter to the next
check <- check[-1,] %>% 
  mutate(growth_rate = (log(`Raw Data`) - log(`First Lag`))/log(`First Lag`) * 100)

# formatting the data variable in terms of year and quarters
Dates <- gsub(":", " ", check$Date) 
check <- check %>% 
  mutate(Time = as.yearqtr(Dates)) %>% 
  select(c(Time, growth_rate)) %>% 
  mutate(growth_rate = as.numeric(growth_rate))

check_xts <- xts(check$growth_rate, check$Time) 

plot(as.zoo(check_xts), 
     plot.type = "single", 
     col = c("darkred"),
     lwd = 1,
     xlab = "Date",
     ylab = "Growth Rate",
     main = "Quarterly Growth Rate of log(GDP)")

# function that transform years to class 'yearqtr'
YToYQTR <- function(years){
  return(
      sort(as.yearqtr(sapply(years, paste, c("Q1", "Q2", "Q3", "Q4"))))
  )
}

# recessions
recessions <- YToYQTR(c(1961:1962, 1970, 1974:1975, 1980:1982, 1990:1991,
                2001, 2007:2008))
# the COVID recession ended in April 2020 according to the Fed
recessions_covid <- append(recessions, 
                           c(as.yearqtr("2020 Q1"), 
                             as.yearqtr("2020 Q2")))
          
# colour shading for recessions
xblocks(time(as.zoo(check_xts)), 
        c(time(check_xts) %in% recessions_covid), 
        col = alpha("steelblue", alpha = 0.3))


## EXPLAIN EVERYTHING 
# variance of initial years (prior to them changing to GDP) seems higher 
```


### AR Function & Model 

```{r autoregression}

# Using the basic AR model from lecture 
# Inputs: Y - predicted variable, p - AR order, h - forecast horizon

fitAR = function(Y, p, h) {
    
    # create p lags + forecast horizon shift (=h option)
    aux = embed(Y, p + h)
    
    # Y variable aligned/adjusted for missing data due to lags
    y = aux[, 1] 
    
    # lags of Y (predictors) corresponding to forecast horizon (prevent leakage)
    X = as.matrix(aux[, -c(1:(ncol(Y) * h))])
    
    # retrieve last p observations
    X.out = tail(aux, 1)[1:ncol(X)] 
    
    # store predictions for each horizon
    preds = numeric(h)
    
    # estimate h-step AR(p) by OLS 
    for (i in 1:h) {
      # Use only the available data for each horizon
      model = lm(y ~ X[, 1:(ncol(X) - i + 1)]) 
      coef = coef(model) 
      
      # Make forecast using the last few observations for the specific horizon
      pred = X.out[1:tail(X.out, i)] %*% coef 
      preds[i] = pred
    }
    
    # Get unadjusted RMSFE (ignoring estimation uncertainty)
    rmsfe = sqrt(sum(model$residuals^2) / nrow(X)) 
    
    # Save estimated AR regression, predictions, and estimated coefficients
    return(preds) 
  }


# Creating a test dataset that comprises the growth_rate from the check dataset 

test_AR <- as.matrix(check$growth_rate)


fitAR(test_AR, 2, 2)

```
#prediction graph for AR model
```
  fitAR=function(Y,p,h){
    
    # create p lags + forecast horizon shift (=h option)
    aux = embed(Y, p+h)
    
    #  Y variable aligned/adjusted for missing data due to lags
    y = aux[,1] 
    
    # lags of Y (predictors) corresponding to forecast horizon (prevent leakage)
    X = as.matrix(aux[,-c(1:(ncol(Y)*h))])
    
    # retrieve last p observations
    X.out = tail(aux,1)[1:ncol(X)] 
    
    # estimate direct h-step AR(p) by OLS 
    model = lm(y~X) 
    
    # extract coefficients
    coef = coef(model) 
    
    #make a forecast using the last few observations: a direct h-step forecast.
    pred = c(1,X.out)%*%coef 
    
    #note the addition of a constant to the test observation vector
    
    #get unadjusted rmsfe (ignoring estimation uncertainty)
    rmsfe = sqrt(sum(model$residuals^2)/nrow(X)) 
    
    #save estimated AR regression, prediction, and estimated coefficients
    return(model)
  }
  
  ##fitAR_preds for predictions at each step along forecast horizon h for line graph
  fitAR_preds = function(Y, p, h) {
    
    # create p lags + forecast horizon shift (=h option)
    aux = embed(Y, p + h)
    
    # Y variable aligned/adjusted for missing data due to lags
    y = aux[, 1] 
    
    # lags of Y (predictors) corresponding to forecast horizon (prevent leakage)
    X = as.matrix(aux[, -c(1:(ncol(Y) * h))])
    
    # retrieve last p observations
    X.out = tail(aux, 1)[1:ncol(X)] 
    
    # store predictions for each horizon
    preds = numeric(h)
    
    # estimate h-step AR(p) by OLS 
    for (i in 1:h) {
      # Use only the available data for each horizon
      model = lm(y ~ X[, 1:(ncol(X) - i + 1)]) 
      coef = coef(model) 
      
      # Make forecast using the last few observations for the specific horizon
      pred = X.out[1:tail(X.out, i)] %*% coef 
      preds[i] = pred
    }
    
    # Get unadjusted RMSFE (ignoring estimation uncertainty)
    rmsfe = sqrt(sum(model$residuals^2) / nrow(X)) 
    
    # Save estimated AR regression, predictions, and estimated coefficients
    return(preds)
  }
  
  
  ## prepping data for model 1
  test <- as.matrix(check$growth_rate)
  
  models <- lapply(1:4, function(p) fitAR(test, p, 2))
  
  aic <- aictab(cand.set = models, modnames = paste0('p=', 1:4))
  
  output$model1 <- renderPlot({
    latest_data <- RGDP_Data$ROUTPUT24Q1
    
    # creating a lag for all quarters
    lag(latest_data)
    
    # check is a dataset to validate whether the data is stationary 
    check <- data.frame(RGDP_Data$DATE, (latest_data), lag(latest_data))
    
    check <- check %>% 
      rename(c("Date" = "RGDP_Data.DATE",
               "Raw Data" = "X.latest_data.",
               "First Lag" = "lag.latest_data."))
    
    # calculating growth rate of GDP from one quarter to the next
    check <- check[-1,] %>% 
      mutate(growth_rate = (`Raw Data` - `First Lag`)/(`First Lag`) * 100)
    
    # formatting the data variable in terms of year and quarters
    Dates <- gsub(":", " ", check$Date) 
    check <- check %>%
      mutate(Time = as.yearqtr(Dates)) %>%
      filter(Time <= input$year) %>% 
      select(Time, growth_rate) %>%
      mutate(growth_rate = as.numeric(growth_rate))
    
    check_xts <- xts(check$growth_rate, check$Time) 
    predictions <- check %>% 
      filter(Time > input$year) %>% 
      mutate(growth_rate = fitAR(test, input$lags, input$forecast_horizon)) %>% 
      select(Time, growth_rate)
    
    # Merge the two time series into a single zoo object
    merged_data <- merge(as.zoo(check_xts), as.zoo(predictions))
    
    # Plot the merged data
    plot(merged_data, 
         plot.type = "single", 
         col = c("darkred", "darkblue"),
         lwd = 1,
         xlab = "Date",
         ylab = "Growth Rate",
         main = "Quarterly Growth Rate of GDP")
    
    
    # function that transform years to class 'yearqtr'
    YToYQTR <- function(years){
      return(
        sort(as.yearqtr(sapply(years, paste, c("Q1", "Q2", "Q3", "Q4"))))
      )
    }
    
    # recessions
    recessions <- YToYQTR(c(1961:1962, 1970, 1974:1975, 1980:1982, 1990:1991,
                            2001, 2007:2008))
    # the COVID recession ended in April 2020 according to the Fed
    recessions_covid <- append(recessions, 
                               c(as.yearqtr("2020 Q1"), 
                                 as.yearqtr("2020 Q2")))
    
    # colour shading for recessions
    xblocks(time(as.zoo(check_xts)), 
            c(time(check_xts) %in% recessions_covid), 
            col = alpha("steelblue", alpha = 0.3))
  })

#########################################

### Preparing for Advanced AR Model 

Our advanced AR model seeks to build on the above basic AR model from the lecture. We are not changing the model itself, but the data that is inputted into this model. The quarterly data undergoes monthly revisions for the first 10 years, leading to initial values being inaccurate. Furthermore, the data is also subject to seasonal revisions (for instance, due to changes in how the calculations are performed), which can lead to sudden jumps in quarterly growth rates. Through processes of transforming the data, we hope to be able to predict the final, revised, values of data based on the initial values provided. This would make forecasts more accurate to the true value.


This function takes in a dataset and splices it according the the relevant row and column ranges to form a square matrix (based on range of quarters with relevant information), and outputs a dataframe with the rows as the quarters and the columns as the revision number, with the values being the percentage change in the data during that revision. The delta returned is the average revision change across all years.

```{r advanced AR prep function}

# n refers to the number of periods that sum up to 10 years for a given dataset. For instance, n = 40 for a dataset arranged by quarters, and n = 120 for a dataset arranged by months.

prep_func = function(dataset, row_range, col_range, n){
  
  # cut dataset into relevant ranges
  
  data_across_q <- dataset[row_range, col_range] %>%
    #subset(select = -DATE) %>%
    mutate_all(as.numeric)
  
  colnames(data_across_q) <- NULL
  
  data_across_q <- as.matrix(data_across_q) 
  
  lagged_data_across_q <- lag(data_across_q)
  
  df <- 100 * (log(data_across_q) - log(lagged_data_across_q))/log(lagged_data_across_q)
  
  # Removing the first and last row since we had added those to compute the lag.
  df <- df[-c(1, length(row_range)),]
  
# Revised values is a data frame that shows the growth rate of each quarter as compared to the previous quarter, across revisions. For instance, revision0 is the initial growth rate for each quarter, and revision1 shows the growth rate after values have been revised. 
  
  revised_growth <- data.frame(matrix(NA, nrow = length(row_range) - 2, ncol = 0))
  
  for (i in 0:n){
    na_vector = c(replicate(length(row_range) - 2, NA)) 
    na_vector = as.numeric(na_vector)
    
    values <- diag(df)
    
    col_name = paste0("revision", i)
    
    na_vector[1:(length(row_range) - 2 -i)] = values[1:(length(row_range) - 2 -i)]
    revised_growth[[`col_name`]] = na_vector
    
    df <- df[,-c(1)]
  }
  
  revised_growth_df <- revised_growth
  
  # Now, we are looking into how the growth rates change due to revision
  lagged_growth <- revised_growth[, -c(ncol(revised_growth))]
  revised_growth <- revised_growth[,-c(1)]
  
  # We're taking the average of the change in growth per revision 
  change_in_growth <- 100*((revised_growth - lagged_growth)/lagged_growth)
  
  change_in_growth[sapply(change_in_growth, is.infinite)] <- NA
    
  change_in_growth <- change_in_growth %>% apply(2, mean, na.rm = TRUE)
  
  return(list("df" = revised_growth_df, "delta" = change_in_growth))
}

dataset <- RGDP_Data
row_range <- c(74:293)
col_range <- c(2:220)

a = RGDP_Data[c(74:293), c(2:220)]

post_prep_gdp <- prep_func(dataset, row_range, col_range, 40)
post_prep_gdp_df <- post_prep_gdp$df
post_prep_gdp_delta = post_prep_gdp$delta

```

### Hstarts 

```{r hstarts prep}

# Housing Starts data only available from 1970 Apr onwards, is in monthly rather than quarterly

hstarts <- read_excel("hstartsMvMd.xlsx")

# Row and column range from 1970 Apr to 2024 Feb (Values from 2024 Mar)

# Accounting for Covid, stopping at Mar 2020 values

hstart_row_range <- c(279:878)
hstart_col_range <- c(28:628)

hstarts_temp <- hstarts[hstart_row_range, hstart_col_range]
hstarts_temp <- hstarts_temp %>% 
  mutate_at(1:ncol(hstarts_temp), as.numeric)

# isolate every third column 
hstarts_temp <- hstarts_temp[, seq(from = 3, to = ncol(hstarts_temp), by = 3)]
# sum up every 3 rows to find quarterly hstarts
num_rep <- nrow(hstarts_temp)/3
hstarts_temp <- rowsum(hstarts_temp, rep(1:num_rep,each=3))

hstart_row_range <- c(1:nrow(hstarts_temp))
hstart_col_range <- c(2:ncol(hstarts_temp))

b <- hstarts_temp[hstart_row_range, hstart_col_range]

# starting data from 1970Q3 instead. the data actually starts from Q2, but we use Q2 to provide Q3's growth rate
post_prep_hstart <- prep_func(hstarts_temp, hstart_row_range, hstart_col_range, 40)
post_prep_hstart_df <- post_prep_hstart$df
post_prep_hstart_delta <- post_prep_hstart$delta

```

### BAA-AAA Data 

```{r baa-aaa prep}

baa_aaa <- read_excel("FRED BAA-AAA Data.xls", col_names = c("Date", "Spread")) %>% 
  mutate(Date = as.yearqtr(Date), 
         Spread = as.numeric(Spread))

```

### Treasury Spread Data 

```{r tspread prep}

tspread <- read_excel("FRED Treasury Spread.xls", col_names = c("Date", "Spread")) %>% 
  mutate(Date = as.yearqtr(Date), 
         Spread = as.numeric(Spread))

```

### FRED Hstarts Data 

```{r fred hstarts prep}

fred_hstarts <- read_excel("FRED Hstarts.xls", col_names = c("Date", "Spread")) %>% 
  mutate(Date = as.yearqtr(Date), 
         Spread = as.numeric(Spread))

```

### FRED Consumer Sentiment Data 

```{r fred hstarts prep}

consent <- read_excel("FRED Consumer Sentiment.xls", col_names = c("Date", "Spread")) %>% 
  mutate(Date = as.yearqtr(Date), 
         Spread = as.numeric(Spread))

```



## Testing 


### Inputs & Basic Manipulation 

```{r input}

example_q = "2014 Q1"
example_yq = as.yearqtr(example_q)

############
## GDP 
############

# Formatting dataframe of quarters and their estimated values
working_df = RGDP_Data[, -c(1)] %>%
  mutate_all(as.numeric)

colnames(working_df) <- sapply(seq(as.Date(as.yearqtr("1965 Q4", format = "%Y Q%q")), by="quarter", length.out = ncol(working_df)), function(x) format(as.yearqtr(x), format = "%Y Q%q"))

rownames(working_df) <- sapply(seq(as.Date(as.yearqtr("1947 Q1", format = "%Y Q%q")), by="quarter", length.out = nrow(working_df)), function(x) format(as.yearqtr(x), format = "%Y Q%q"))

# Calculating growth rate of each quarter
lagged_working_df = lag(working_df)
perc_change_df = (100 * (log(working_df) - log(lagged_working_df)) / log(lagged_working_df))[-c(1),]


############
## HStarts
############

# revised hstarts data 

hstart_row_range <- c(1:nrow(hstarts_temp))
hstart_col_range <- c(2:ncol(hstarts_temp))

hstarts_revised <- hstarts_temp[hstart_row_range, hstart_col_range]

colnames(hstarts_revised) <- sapply(seq(as.Date(as.yearqtr("1970 Q3", format = "%Y Q%q")), by="quarter", length.out = ncol(hstarts_revised)), function(x) format(as.yearqtr(x), format = "%Y Q%q"))

rownames(hstarts_revised) <- sapply(seq(as.Date(as.yearqtr("1970 Q2", format = "%Y Q%q")), by="quarter", length.out = nrow(hstarts_revised)), function(x) format(as.yearqtr(x), format = "%Y Q%q"))

# Calculating growth rate of each quarter
lagged_hstarts_revised = lag(hstarts_revised)
perc_change_df_hstarts = (100 * (log(hstarts_revised) - log(lagged_hstarts_revised)) / log(hstarts_revised))[-c(1),]

```


### Basic AR Model 

```{r basic AR}

end_of_row_mark = (example_yq - as.yearqtr("1947 Q1", format = "%Y Q%q")) * 4 - 1

basic_values <- perc_change_df[1:end_of_row_mark,][[`example_q`]]

test <- as.matrix(basic_values)

basic_AR_model = fitAR(test, 2, 2)

basic_example_forecast = basic_AR_model$pred
basic_example_model = basic_AR_model$model
basic_example_forecast

AIC_basicAR = AIC(basic_AR_model$model)
AIC_basicAR


```


### Advanced AR Model 

```{r advanced AR}

# Split dataframe into 10 years before target date and current value of growth for quarters more than 10 years ago
ten_year_mark = (example_yq - 10 - as.yearqtr("1947 Q1", format = "%Y Q%q")) * 4
end_of_row_mark = (example_yq - as.yearqtr("1947 Q1", format = "%Y Q%q")) * 4 - 1

# Most recent values for start of time to 10 years before target date
ancient_values <- perc_change_df[1:ten_year_mark,][[`example_q`]]

# All other values
recent_values <- perc_change_df[(ten_year_mark + 1):
                                  end_of_row_mark,][[`example_q`]]

# Applying approximation of final growth numbers on recent values
forecast_growth = recent_values 
for (i in 1:length(recent_values)){
  for (j in 1:i){
    forecast_growth[i] = forecast_growth[i] * (1 + (post_prep_gdp_delta[40 - j] / 100) )
  }
}

all_GDP_data = c(ancient_values, forecast_growth)


test2 <- as.matrix(all_GDP_data)

AR_fitted_model = fitAR(test2, 2, 2)

advanced_example_forecast = AR_fitted_model$pred
advanced_example_model = AR_fitted_model$model
advanced_example_forecast

plot(c(all_GDP_data), type = "l", lwd = 1)
plot(c(all_GDP_data, advanced_example_forecast), type = "l", lwd = 1)

AIC_advancedAR = AIC(AR_fitted_model$model)
AIC_advancedAR

```

### ADL Model - Housing Starts 


```{r ADL model hstarts}

example_q = "2014 Q1"
example_yq = as.yearqtr(example_q) + 1/4
y = as.numeric(year(example_yq))
q = as.numeric(quarter(example_yq) - 1)

# prepping GDP data 

ten_year_mark = (example_yq - 10 - as.yearqtr("1970 Q3", format = "%Y Q%q")) * 4
end_of_row_mark = (example_yq - as.yearqtr("1970 Q3", format = "%Y Q%q")) * 4 - 1 

# Most recent values for start of time to 10 years before target date
ancient_values <- perc_change_df[1:ten_year_mark,][[`example_q`]]

# All other values
recent_values <- perc_change_df[(ten_year_mark + 1):
                                  end_of_row_mark,][[`example_q`]]

# Applying approximation of final growth numbers on recent values
forecast_growth = recent_values 
for (i in 1:length(recent_values)){
  for (j in 1:i){
    forecast_growth[i] = forecast_growth[i] * (1 + (post_prep_gdp_delta[40 - j] / 100) )
  }
}

all_GDP_data = c(ancient_values, forecast_growth)


# prepping hstarts data 

# Most recent values for start of time to 10 years before target date
ancient_values_hstarts <-  perc_change_df_hstarts[1:ten_year_mark,][[`example_q`]]

# All other values
recent_values_hstarts <- perc_change_df_hstarts[(ten_year_mark + 1):
                                  end_of_row_mark,][[`example_q`]]

# Applying approximation of final growth numbers on recent values
forecast_growth_hstarts = recent_values_hstarts 
for (i in 1:length(recent_values_hstarts)){
  for (j in 1:i){
    forecast_growth_hstarts[i] = forecast_growth_hstarts[i] * (1 + (post_prep_hstart_delta[40 - j] / 100) )
  }
}

all_hstarts_data = c(ancient_values_hstarts, forecast_growth_hstarts)


# adjusted GDP data = all_GDP_data 
# adjusted hstarts data = all_hstarts_data

# Why housing starts?

# Convert the GDP delta to a time series 
GDPGrowth_ts <- ts(all_GDP_data, 
                  start = c(1970, 3), 
                  end = c(y, q), 
                  frequency = 4)

hstartsGrowth_ts <- ts(all_hstarts_data, 
                start = c(1970, 3), 
                end = c(y, q), 
                frequency = 4)

plot(merge(as.zoo(GDPGrowth_ts), as.zoo(hstartsGrowth_ts)), 
     plot.type = "single", 
     col = c("darkred", "steelblue"),
     lwd = 2,
     xlab = "Date",
     ylab = "Percent per annum",
     main = "Interest Rates")

# doesn't seem to be much of a relationship 

ADL1data <- ts.union(GDPGrowth_ts, hstartsGrowth_ts)

# estimating the ADL(2,1) model of GDP growth

GDPGR_ADL21 <- 
  dynlm(GDPGrowth_ts ~ L(GDPGrowth_ts) + L(GDPGrowth_ts, 2) +
                       L(hstartsGrowth_ts) + L(hstartsGrowth_ts, 2) + L(hstartsGrowth_ts, 3), 
                     start = c(1970, 3), end = c(y, q))

ADL_coefficients <- GDPGR_ADL21$coefficients

coeftest(GDPGR_ADL21)

```


### ADL Model - BAA-AAA Spread 

```{r adl model baa-aaa}

baa_aaa <- baa_aaa[3:nrow(baa_aaa), ]

baa_aaa_ts <- ts(baa_aaa$Spread, 
                start = c(1970, 3), 
                end = c(y, q), 
                frequency = 4)

plot(merge(as.zoo(GDPGrowth_ts), as.zoo(baa_aaa_ts)), 
     plot.type = "single", 
     col = c("darkred", "steelblue"),
     lwd = 2,
     xlab = "Date",
     ylab = "",
     main = "Interest Rates")

# doesn't seem to be much of a relationship 

ADL2data <- ts.union(GDPGrowth_ts, baa_aaa_ts)

# estimating the ADL(2,1) model of GDP growth

GDPGR_ADL21 <- 
  dynlm(GDPGrowth_ts ~ L(GDPGrowth_ts) + L(GDPGrowth_ts, 2) +
                       L(GDPGrowth_ts, 3) + 
                       L(baa_aaa_ts) + L(baa_aaa_ts, 2) + 
                       L(baa_aaa_ts, 3),
                     start = c(1970, 3), end = c(y, q))

ADL_coefficients <- GDPGR_ADL21$coefficients

coeftest(GDPGR_ADL21)

```


### ADL Model - Treasury Spread 

```{r adl model tspread}

all_GDP_data <- all_GDP_data[25: length(all_GDP_data)]

GDPGrowth_ts <- ts(all_GDP_data, 
                  start = c(1976, 4), 
                  end = c(y, q), 
                  frequency = 4)

tspread_ts <- ts(tspread$Spread, 
                start = c(1976, 4), 
                end = c(y, q), 
                frequency = 4)

plot(merge(as.zoo(GDPGrowth_ts), as.zoo(tspread_ts)), 
     plot.type = "single", 
     col = c("darkred", "steelblue"),
     lwd = 2,
     xlab = "Date",
     ylab = "",
     main = "Interest Rates")

# estimating the ADL(2,1) model of GDP growth

GDPGR_ADL21 <- 
  dynlm(GDPGrowth_ts ~ L(GDPGrowth_ts) + L(GDPGrowth_ts, 2) + 
                       L(GDPGrowth_ts, 3) + 
                       L(tspread_ts) + L(tspread_ts, 2) + 
                       L(tspread_ts, 3) + L(tspread_ts, 4),
                     start = c(1976, 4), end = c(y, q))

ADL_coefficients <- GDPGR_ADL21$coefficients

coeftest(GDPGR_ADL21)

```


### ADL Model - FRED Hstarts

```{r adl model fred hstarts}

# Split dataframe into 10 years before target date and current value of growth for quarters more than 10 years ago
ten_year_mark = (example_yq - 10 - as.yearqtr("1959 Q1", format = "%Y Q%q")) * 4
end_of_row_mark = (example_yq - as.yearqtr("1959 Q1", format = "%Y Q%q")) * 4 - 1

# Most recent values for start of time to 10 years before target date
ancient_values <- perc_change_df[1:ten_year_mark,][[`example_q`]]

# All other values
recent_values <- perc_change_df[(ten_year_mark + 1):
                                  end_of_row_mark,][[`example_q`]]

# Applying approximation of final growth numbers on recent values
forecast_growth = recent_values 
for (i in 1:length(recent_values)){
  for (j in 1:i){
    forecast_growth[i] = forecast_growth[i] * (1 + (post_prep_gdp_delta[40 - j] / 100) )
  }
}

all_GDP_data = c(ancient_values, forecast_growth)


GDPGrowth_ts <- ts(all_GDP_data, 
                  start = c(1959, 1), 
                  end = c(y, q), 
                  frequency = 4)

fred_hstarts_ts <- ts(fred_hstarts$Spread, 
                start = c(1959, 1), 
                end = c(y, q), 
                frequency = 4)

plot(merge(as.zoo(GDPGrowth_ts), as.zoo(fred_hstarts_ts)), 
     plot.type = "single", 
     col = c("darkred", "steelblue"),
     lwd = 2,
     xlab = "Date",
     ylab = "",
     main = "Interest Rates")

# estimating the ADL(2,1) model of GDP growth

GDPGR_ADL21 <- 
  dynlm(GDPGrowth_ts ~ L(GDPGrowth_ts) + L(GDPGrowth_ts, 2) + 
                       L(GDPGrowth_ts, 3) + 
                       L(fred_hstarts_ts),
                     start = c(1959, 1), end = c(y, q))

ADL_coefficients <- GDPGR_ADL21$coefficients

coeftest(GDPGR_ADL21)

# HSTARTS VERY BAD.

```


### ADL Model - Consumer Sentiment

```{r adl model fred hstarts}

all_GDP_data = all_GDP_data[25: length(all_GDP_data)]


GDPGrowth_ts <- ts(all_GDP_data, 
                  start = c(1960, 1), 
                  end = c(y, q), 
                  frequency = 4)

consent_ts <- ts(consent$Spread, 
                start = c(1960, 1), 
                end = c(y, q), 
                frequency = 4)

plot(merge(as.zoo(GDPGrowth_ts), as.zoo(consent_ts)), 
     plot.type = "single", 
     col = c("darkred", "steelblue"),
     lwd = 2,
     xlab = "Date",
     ylab = "",
     main = "Interest Rates")

# estimating the ADL(2,1) model of GDP growth

GDPGR_ADL21 <- 
  dynlm(GDPGrowth_ts ~ L(GDPGrowth_ts) + L(GDPGrowth_ts, 2) + 
                       L(GDPGrowth_ts, 3) + 
                       L(consent_ts),
                     start = c(1960, 1), end = c(y, q))

ADL_coefficients <- GDPGR_ADL21$coefficients

coeftest(GDPGR_ADL21)

```


### ARIMA Model

```{r arima}

output <- auto.arima(all_GDP_data)
predict(output, n.ahead = 2)


```



