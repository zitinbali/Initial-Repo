
```{r import, warning = FALSE, results= "hide", echo = FALSE}

source("GDP Cleaning.R")
source("inputs.R")
source("ADL Data.R")
source("AR_Model_Functions.R")
source("ADL Functions.R")
source("Combined ADL Model Functions.R")

```


# Poor Outlook Function

This function analyses how many of our ADL predictions until and including the forecast horizon are less than 0. i.e. Predicting a negative GDP Growth Rate. 


```{r poor outlook}

# X variables is a vector; input would be ADL variables
poor_outlook <- function(Y_dataframe, X_variables, f_horizon){
  
  m <- length(X_variables)
  
  forecast_output <- c() 
  for (i in 1:m){
    X_temp <- get(X_variables[i])
    for (j in 1:f_horizon){
      forecast <- (ADL_predict_all(Y_dataframe, X_temp, j, covid_dummy = covid_dummy))$prediction
      forecast_output <- append(forecast_output, forecast)
    }
  }
  
  # what is the number of forecasts that are less than 0
  num_poor_forecast <- sum(forecast_output < 0)
  
  # what is the percentage of forecasts < 0
  perc_poor_forecast <- num_poor_forecast/length(forecast_output)
  
  # identifying which indicators show a poor forecast
  
  # indexes of the indicators predicting GDP growth rate < 0
  less_than_zero <- which(forecast_output < 0)
  less_than_zero <- ifelse(less_than_zero > 5, less_than_zero %% 5, less_than_zero)
  less_than_zero[less_than_zero == 0] <- 5
  
  # names of unique indicators which predict GDP growth rate < 0
  less_than_zero <- unique(less_than_zero)
  indicators_poor <- X_variables[less_than_zero]
  
  if (is_empty(unique(indicators_poor))){
    output_message = "None of the ADL predictors forecast a negative GDP growth rate."
    indicators_output = NULL
  } else {
    output_message = "Some of the ADL predictors forecast a negative GDP growth rate."
    indicators_output = unique(indicators_poor)
  }
  return(list("message" = output_message, "indicators" = indicators_output))
}


poor_outlook(GDPGrowth_ts, ADL_variables, 2)

```


# Abnormalities Function

How many of the indicators have been behaving weirdly in the last 4 quarters? This would indicate an imminent crisis. 

The function returns a list comprising a message and the indicators that are behaving abnormally (if any). If the indicators are behaving normally, the output for indicators will be NULL.


```{r abnormalities}


abnormal <- function(X_variables){
  
  m <- length(X_variables)
  indicators <- c()

  for (i in 1:m){
    X_temp <- get(X_variables[i])
    name_indicator <- X_variables[i]
    
    # median of the X variable
    median_value <- median(X_temp)
    
    # calculate the median absolute deviation (MAD)
    mad_value <- mad(X_temp)
    
    # set the threshold for outlier detection (3 times the MAD)
    threshold <- 3 * mad_value
    
    # calculate the absolute deviations from the median
    absolute_deviations <- abs(X_temp - median_value)
    
    # identify outliers 
    outliers <- X_temp[absolute_deviations > threshold]
    
    # subset last 4 entries
    last_4_entries <- tail(X_temp, 4)
    
    # NEED TO CHANGE THIS LATER 
    # ONLY APPLICABLE TO POSITIVE INDICATORS (WHERE GROWTH > 0 IS A GOOD THING)
    count_true <- sum(last_4_entries < 0)
    
    # check if any of the outliers correspond to the last 4 entries
    if(any(last_4_entries %in% outliers) | count_true == 4){
      indicators <- append(indicators, name_indicator)
    }
  }
  
  if (length(indicators) == 0){
    output_message = "All good!"
  } 
  else {
    output_message = "Markets have been deviating from the norm severely in the last year. If a recession or rapid economic boom is not already taking place, one might occur soon. Conduct deeper analysis into the deviating predictors to arrive at more conclusive results."
  }
  
  return(list("message" = output_message, "indicators" = indicators))
}

abnormal(ADL_variables)


```


# Aggregate Forecast Function

Aggregates the forecasts

```{r aggregate forecast}


aggregate_output <- function(Y_dataframe, X_variables, AR_input, f_horizon, dum){
  
  forecast_output <- c() 
  
  # Advanced AR prediction
  advanced_AR_output <- fitAR(AR_input, example_fhorizon, dum)
  ar2_prediction = advanced_AR_output$pred
  
  forecast_output <- append(forecast_output, ar2_prediction)
  
  
  # ADL outputs 
  m <- length(X_variables)
  
  forecast_output <- c() 
  for (i in 1:m){
    X_temp <- get(X_variables[i])
    for (j in 1:f_horizon){
      forecast <- (ADL_predict_all(Y_dataframe, X_temp, j, covid_dummy = covid_dummy))$prediction
      forecast_output <- append(forecast_output, forecast)
    }
  }
  
  # Combined ADL output 
  
  # Creating combined dataset 
  name_ts_first <- ADL_variables[1]
  X_comb <- get(name_ts_first)
  
  for (j in 2:m){
    X_temp <- get(X_variables[i])
    for (j in 1:f_horizon){
      name_ts <- ADL_variables[m]
      X_new <- get(name_ts)
      X_comb <- ts.union(X_comb, X_new)
    }
  }
  
  # comb ADL output 
  comb_ADL_output <- ADL_comb_predict_all(Y_dataframe, X_comb, f_horizon, example_endq)$prediction
  forecast_output <- append(forecast_output, comb_ADL_output)
  
  mean_output <- mean(forecast_output)
  
  # call poor outlook function 
  poor_outlook <- poor_outlook(Y_dataframe, X_variables, f_horizon)
  
  # call abnormalities function 
  abnormal <- abnormal(X_variables)
  
  return(list("prediction" = mean_output, "outlook" = poor_outlook, "abnormal" = abnormal))
}

```


## TEST 

```{r aggregate test}

advanced_AR_input <- adv_ar_input(RGDP_Data, example_startq, example_endq)
aggregate_output(GDPGrowth_ts, ADL_variables, advanced_AR_input, 2, covid_dummy)

```



