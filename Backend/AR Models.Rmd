
```{r import, warning = FALSE, results= "hide", echo = FALSE}

source("GDP Cleaning.R")
source("inputs.R")

```

### AR Function 

```{r AR function}

# Using the basic AR model from lecture 
# Inputs: Y - predicted variable, p - AR order, h - forecast horizon

fitAR=function(Y,p,h){
  
  # create p lags + forecast horizon shift (=h option)
  aux = embed(Y, p+h)
  
  #  Y variable aligned/adjusted for missing data due to lags
  y = aux[,1] 
  
  # lags of Y (predictors) corresponding to forecast horizon (prevent leakage)
  X = as.matrix(aux[,-c(1:(ncol(Y)*h))])

  # retrieve last p observations
  X.out = tail(aux,1)[1:ncol(X)] 

  # estimate direct h-step AR(p) by OLS 
  model = lm(y~X) 
  
  # extract coefficients
  coef = coef(model) 

  #make a forecast using the last few observations: a direct h-step forecast.
  pred = c(1,X.out)%*%coef 
  
  #note the addition of a constant to the test observation vector
  
  #get unadjusted rmsfe (ignoring estimation uncertainty)
  rmsfe = sqrt(sum(model$residuals^2)/nrow(X)) 
  
  #save estimated AR regression, prediction, and estimated coefficients
  return(list("model"=model,"pred"=pred,"coef"=coef, "rmsfe"=rmsfe)) 
}

```

### Basic AR Model 

```{r AR Model 1}

# Creating a test dataset that comprises the growth_rate from the check dataset

start_rownum = which(grepl(example_startyq, check$Time))
end_rownum = which(grepl(example_endyq, check$Time))

basic_AR_input <- check[start_rownum:end_rownum, ] %>% 
  select(growth_rate) %>% 
  as.matrix()

p_optimal = 4
h = example_fhorizon

basic_AR_output <- fitAR(basic_AR_input, p_optimal, example_fhorizon)

ar1_prediction = basic_AR_output$pred
ar1_rmsfe = basic_AR_output$rmsfe

```


### Advanced AR Model 

```{r Advanced AR model, warning = FALSE}

spliced_GDP <- data_splice(RGDP_Data, "1947 Q1", "2023 Q4", "1965 Q4", 
                           "2024 Q1", example_startyq, example_endyq)

post_prep_gdp <- prep_func(spliced_GDP, 40)
post_prep_gdp_df <- post_prep_gdp$df
post_prep_gdp_delta = post_prep_gdp$delta

#####################
## revise GDP values
#####################

# note that the last input should be in a string format
all_GDP_data <- revise_values(perc_change_df, post_prep_gdp_delta, example_endq)

advanced_AR_input <- as.matrix(all_GDP_data)


advanced_AR_output <- fitAR(advanced_AR_input, p_optimal, example_fhorizon)

ar2_prediction = advanced_AR_output$pred
ar2_msfe = advanced_AR_output$msfe

```
